# 연관관계 매핑 기초

# 단방향 연관관계

객체를 테이블에 맞추어 데이터 중심으로 모델링하면, 협력 관계를 만들 수 없다. 

- 테블은 외래 키로 조인을 사용해 연관된 테이블을 찾는다.
- 객체는 참조를 사용해 연관된 객체를 찾는다.

---

# 양방향 연관관계와 연관관계의 주인 1 - 기본

외래키로 양방향으로 가능 : 테이블

![IMG_81B1AEF7246A-1](https://github.com/LAB-2023/LAB_study/assets/125250173/752582bb-1a5e-4117-a7ac-a4346a6f9018)

## **양방향 매핑** : 반대 방향으로 객체 그래프 탐색

## 연관관계의 주인과 mappedBy

 @OneToMany(mappedBy = "team")

객체와 테이블간에 연관관계를 맺는 차이를 이해해야 한다.

### 객체와 테이블이 관계를 맺는 차이 : 출발점

객체 연관관계 = 2개

Member → Team : 단방향

Team → Member : 단방향

테이블 연관관계 = 1개

외래키와 fk

회원 ↔ 팀 : 방향이 없는거

### 객체의 양방향 관계

객체의 양방향 관계는 사실 양방향 관계가 아니라 서로 다른 단방향 관계 2개다

### 테이블의 양방향 연관관계

테이블은 **외래 키** 하나로 두 테이블의 연관관계를 관리

## 둘 중 하나로 외래 키를 관리

Member의 team을 바꿀지 Team의 members를 바꿀지 딜레마

### 연관관계의 주인(Owner)

양방향 매핑 규칙

- 객체의 두 관계 중 하나를 연관관계의 주인으로 지정
- **연관관계의 주인만이 외래 키를 관리(등록, 수정)**
- **주인이 아닌 쪽은 읽기만 가능**
- 주인은 mappedBy 속성 사용 안됨
- 주인이 아니면 mappedBy 속성으로 주인 지정

**🔥 외래 키가 있는 곳을 주인으로 정해라🔥**

**N쪽이 주인이 된다.(Many)**

![IMG_5F8E9C872A00-1](https://github.com/LAB-2023/LAB_study/assets/125250173/92cb749d-3c3b-47de-976c-e39780d7bc25)

가짜매핑 : Team의 멤버를 바꿨는데 Member의 테이블이 update 된다.

---

# 양방향 연관관계와 연관관계의 주인2 - 주의점, 정리

## 양방향 매핑 시 연관관계의 주인에 값을 입력해야 한다.

- 순수한 객체 관계를 고려하면 항상 양쪽 다 값을 입력해야 한다.
    
    em.flush(), em.clear()를 하거나 양쪽 다 값을 입력해야 된다.
    
    → 1차 캐시에 들어가면 members값은 저장되지 않음.
    
- 연관관계 편의 메소드를 생성하자
- 양방향 매핑시에 무한루프를 조심하자
    
    ex) toString(), lombok, JSON 생성 라이브러리(s: dto 사용하기)
    

## 양방향 매핑 정리

- 단방향 매핑만으로도 이미 연관관계 매핑 완료
- 양방향 매핑은 반대 방향으로 조회(객체 그래프 탐색) 기능이 추가된 것
- JPQL에서 역방향으로 탐색할 일이 많음
- 단방향 매핑을 잘 하고 양바향은 필요할 때 추가해도됨(테이블에 영향을 주지 않음)

### 연관관계의 주인을 정하는 기준

- 비즈니스 로직을 기준으로 연관관계의 주인을 선택하면 안됨
- 연관관계의 주인은 외래 키의 위치를 기준으로 정해야함