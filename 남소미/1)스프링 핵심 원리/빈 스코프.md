# ë¹ˆ ìŠ¤ì½”í”„

### ë¹ˆ ìŠ¤ì½”í”„ë€?

: ìŠ¤ì½”í”„ëŠ” ë¹ˆì´ ì¡´ì¬í•  ìˆ˜ ìˆëŠ” ë²”ìœ„ë¥¼ ëœ»í•¨.

- **ì‹±ê¸€í†¤** : ê¸°ë³¸, ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì˜ ì‹œì‘ê³¼ ì¢…ë£Œê¹Œì§€ ìœ ì§€, ê°€ì¥ ë„“ìŒ
- **í”„ë¡œí† íƒ€ì…** : ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆëŠ” í”„ë¡œí† íƒ€ì… ë¹ˆì˜ ìƒì„±ê³¼ ì˜ì¡´ê´€ê³„ ì£¼ì…ê¹Œì§€ë§Œ ê´€ì—¬, ë§¤ìš° ì§§ìŒ
- **ì›¹ ê´€ë ¨ ìŠ¤ì½”í”„**
    - request : ì›¹ ìš”ì²­ì´ ë“¤ì–´ì˜¤ê³  ë‚˜ê°ˆë•Œ ê¹Œì§€ ìœ ì§€
    - session : ì›¹ ì„¸ì…˜ì´ ìƒì„±ë˜ê³  ì¢…ë£Œë  ë•Œ ê¹Œì§€ ìœ ì§€
    - application : ì›¹ì˜ ì„œë¸”ë¦¿ ì»¨í…ìŠ¤íŠ¸ì™€ ê°™ì€ ë²”ìœ„ë¡œ ìœ ì§€

ë¹ˆ ìŠ¤ì½”í”„ ì§€ì •

- ì»´í¬ë„ŒíŠ¸ ìŠ¤ìº” ìë™ ë“±ë¡

```java
@Scope("prototype")
@Component
public class HelloBean {}
```

- ìˆ˜ë™ ë“±ë¡

```java
@Scope("prototype")
@Bean
PrototypeBean HelloBean() {
 return new HelloBean();
}
```

---

### í”„ë¡œí† íƒ€ì… ìŠ¤ì½”í”„

- ì‹±ê¸€í†¤ ìŠ¤ì½”í”„ ì¡°íšŒ : **í•­ìƒ ê°™ì€ ì¸ìŠ¤í„´ìŠ¤**ì˜ ìŠ¤í”„ë§ ë¹ˆì„ ë°˜í™˜

![Untitled](https://github.com/LAB-2023/LAB_study/assets/125250173/e9fb5146-bea7-4a33-9af5-8f409b13673b)

- **í”„ë¡œí† íƒ€ì… ìŠ¤ì½”í”„** ì¡°íšŒ : **í•­ìƒ ìƒˆë¡œìš´ ì¸ìŠ¤í„´ìŠ¤**ë¥¼ ìƒì„±í•´ì„œ ë°˜í™˜

![Untitled 1](https://github.com/LAB-2023/LAB_study/assets/125250173/629d2b2f-dd92-4e6e-8778-16557fe7468e)

![Untitled 2](https://github.com/LAB-2023/LAB_study/assets/125250173/f66b0b09-71b1-4c3c-8f7f-34e8570b7ed1)

<aside>
ğŸ’¡ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆëŠ” **í”„ë¡œí† íƒ€ì… ë¹ˆì„ ìƒì„±í•˜ê³ , ì˜ì¡´ê´€ê³„ ì£¼ì…, ì´ˆê¸°í™”**ê¹Œì§€ë§Œ ì²˜ë¦¬

â†’ í”„ë¡œí† íƒ€ì… ë¹ˆì„ ê´€ë¦¬í•  ì±…ì„ì€ ë°›ì€í´ë¼ì´ì–¸íŠ¸ì—ê²Œ.

â†’ **@PreDestroy ê°™ì€ ì¢…ë£Œ ë©”ì„œë“œ í˜¸ì¶œX**

</aside>

### í”„ë¡œí† íƒ€ì… ìŠ¤ì½”í”„ - ì‹±ê¸€í†¤ ë¹ˆê³¼ í•¨ê»˜ ì‚¬ìš©

**ë¬¸ì œ**

![Untitled 3](https://github.com/LAB-2023/LAB_study/assets/125250173/5a71e0bd-1b0b-4eac-96c9-b50c79b8b2ad)

clientBean ( ì‹±ê¸€í†¤ ë¹ˆ ) : ìƒì„± ì‹œì ì—ë§Œ ì˜ì¡´ê´€ê³„ ì£¼ì…ì„ ë°›ê¸° ë•Œë¬¸ì— í”„ë¡œí† íƒ€ì… ë¹ˆì„ ì£¼ì… ì‹œì ì—ë§Œ ìƒˆë¡œ ìƒì„± 

- ì‹±ê¸€í†¤ì´ë¯€ë¡œ í•­ìƒ ê°™ì€ clientBean ì´ ë°˜í™˜ ( 0 â†’ 1 â†’ 2 )

**SOLUTION** 

**( ì‹±ê¸€í†¤ ë¹ˆê³¼ í•¨ê»˜ ì‚¬ìš©ì‹œ Providerë¡œ ë¬¸ì œ í•´ê²° )**

â†’ í”„ë¡œí† íƒ€ì… ë¹ˆì„ ì‚¬ìš©í•  ë•Œ ë§ˆë‹¤ ìƒˆë¡œ ìƒì„±í•´ì„œ ì‚¬ìš©í•˜ë„ë¡

**ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ìš”ì²­**
: ì‹±ê¸€í†¤ ë¹ˆì´ í”„ë¡œí† íƒ€ì…ì„ ì‚¬ìš©í•  ë•Œ ë§ˆë‹¤ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆì— ìƒˆë¡œ ìš”ì²­

```java
@Autowired
private ApplicationContext ac;
public int logic() {
 PrototypeBean prototypeBean = ac.getBean(PrototypeBean.class);
 prototypeBean.addCount();
 int count = prototypeBean.getCount();
 return count;
}
...
```

- DI : ì˜ì¡´ê´€ê³„ë¥¼ ì™¸ë¶€ì—ì„œ ì£¼ì…
- DL : Dependency Lookup, ì˜ì¡´ê´€ê³„ íƒìƒ‰
    - ì§ì ‘ í•„ìš”í•œ ì˜ì¡´ê´€ê³„ë¥¼ ì°¾ëŠ” ê²ƒ
    â†’ ì´ ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ” ë¬´ì–¸ê°€ê°€ í•„ìš”í•¨

**1) ObjectFactory, ObjectProvider**

- ObjectProvider : ì§€ì •í•œ ë¹ˆì„ ì»¨í…Œì´ë„ˆì—ì„œ ëŒ€ì‹  ì°¾ì•„ì¤Œ ( DL )

```java
@Autowired
private ObjectProvider<PrototypeBean> prototypeBeanProvider;
public int logic() {
	 PrototypeBean prototypeBean = prototypeBeanProvider.getObject();
	 prototypeBean.addCount();
	 int count = prototypeBean.getCount();
	 return count;
}
```

**íŠ¹ì§•**

- ObjectFactory: ê¸°ëŠ¥ì´ ë‹¨ìˆœ, ë³„ë„ì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ í•„ìš” ì—†ìŒ, ìŠ¤í”„ë§ì— ì˜ì¡´
- ObjectProvider: ObjectFactory + í¸ì˜ ê¸°ëŠ¥

2**) JSR-330 Provider**

- javax.inject.Provider ë¼ëŠ” JSR-330 ìë°” í‘œì¤€ì„ ì‚¬ìš©
- provider.get() ì„ í†µí•´ì„œ í•­ìƒ ìƒˆë¡œìš´ í”„ë¡œí† íƒ€ì… ë¹ˆì´ ìƒì„±

```java
@Autowired
private Provider<PrototypeBean> provider;
public int logic() {
	 PrototypeBean prototypeBean = provider.get();
	 prototypeBean.addCount();
	 int count = prototypeBean.getCount();
	 return count;
}
```

**íŠ¹ì§•**

- get() ë©”ì„œë“œ í•˜ë‚˜ë¡œ ê¸°ëŠ¥ì´ ë§¤ìš° ë‹¨ìˆœ
- ë³„ë„ì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”
- ìë°” í‘œì¤€ì´ë¯€ë¡œ ìŠ¤í”„ë§ì´ ì•„ë‹Œ ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆì—ì„œë„ ì‚¬ìš©ê°€ëŠ¥

---

### ì›¹ ìŠ¤ì½”í”„

- ì›¹ í™˜ê²½ì—ì„œë§Œ ë™ì‘
- í”„ë¡œí† íƒ€ì…ê³¼ ë‹¤ë¥´ê²Œ ìŠ¤í”„ë§ì´ í•´ë‹¹ ìŠ¤ì½”í”„ì˜ ì¢…ë£Œì‹œì ê¹Œì§€ ê´€ë¦¬
    - ì¢…ë£Œ ë©”ì„œë“œ í˜¸ì¶œ
- HTTP request ìš”ì²­ ë‹¹ ê°ê° í• ë‹¹ë˜ëŠ” request ìŠ¤ì½”í”„

![Untitled 4](https://github.com/LAB-2023/LAB_study/assets/125250173/6cb5e5d6-8015-40db-983b-d378c0e806d8)

### request ìŠ¤ì½”í”„ ì˜ˆì œ ë§Œë“¤ê¸°

```java
//web ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€
implementation 'org.springframework.boot:spring-boot-starter-web'
```

- ë¡œê·¸ ê¸°ëŠ¥ ê°œë°œ
    - ê³µí†µ í¬ë©§: [UUID][requestURL] {message}
    UUID â†’ HTTP ìš”ì²­ì„ êµ¬ë¶„
    requestURL ì •ë³´ â†’ ì–´ë–¤ URLì„ ìš”ì²­í•´ì„œ ë‚¨ì€ ë¡œê·¸ì¸ì§€ í™•ì¸

```java
@Component
@Scope(value = "request")
public class MyLogger {
    private String uuid;
    private String requestURL;
    public void setRequestURL(String requestURL) {
        this.requestURL = requestURL;
    }
    public void log(String message) {
        System.out.println("[" + uuid + "]" + "[" + requestURL + "] " +
                message);
    }
    @PostConstruct
    public void init() {
        uuid = UUID.randomUUID().toString();
        System.out.println("[" + uuid + "] request scope bean create:" + this);
    }
    @PreDestroy
    public void close() {
        System.out.println("[" + uuid + "] request scope bean close:" + this);
    }
}
```

- í…ŒìŠ¤íŠ¸
    - ë¡œê±°ê°€ ì˜ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” í…ŒìŠ¤íŠ¸ìš© ì»¨íŠ¸ë¡¤ëŸ¬
        - HttpServletRequestë¥¼ í†µí•´ì„œ ìš”ì²­ URLì„ ë°›ê³  ì €ì¥
        - HTTP ìš”ì²­ ë‹¹ ê°ê° êµ¬ë¶„ë˜ë¯€ë¡œ ë‹¤ë¥¸ HTTP ìš”ì²­ ë•Œë¬¸ì— ê°’ì´ ì„ì´ì§€ X
        
        ```java
        @Controller
        @RequiredArgsConstructor
        public class LogDemoController {
            private final LogDemoService logDemoService;
            private final MyLogger myLogger;
            @RequestMapping("log-demo")
            @ResponseBody
            public String logDemo(HttpServletRequest request) {
                String requestURL = request.getRequestURL().toString();
                myLogger.setRequestURL(requestURL);
                myLogger.log("controller test");
                logDemoService.logic("testId");
                return "OK";
            }
        }
        ```
        
    - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ìˆëŠ” ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œë„ ë¡œê·¸ë¥¼ ì¶œë ¥
        - ì›¹ê³¼ ê´€ë ¨ëœ ì •ë³´ê°€ ì›¹ê³¼ ê´€ë ¨ì—†ëŠ” ì„œë¹„ìŠ¤ ê³„ì¸µê¹Œì§€ ë„˜ì–´ê°
        - ì›¹ê³¼ ê´€ë ¨ëœ ë¶€ë¶„ì€ ì»¨íŠ¸ë¡¤ëŸ¬ê¹Œì§€ë§Œ ì‚¬ìš©
        
        ```java
        @Service
        @RequiredArgsConstructor
        public class LogDemoService {
            private final MyLogger myLogger;
            public void logic(String id) {
                myLogger.log("service id = " + id);
            }
        }
        ```
        
- ë¬¸ì œ ë°œìƒ

ìŠ¤í”„ë§ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰í•˜ëŠ” ì‹œì ì— ì‹±ê¸€í†¤ ë¹ˆì€ ìƒì„±í•´ì„œ ì£¼ì…ì´ ê°€ëŠ¥ request ìŠ¤ì½”í”„ ë¹ˆì€ ì•„ì§ ìƒì„± X â†’ ì‹¤ì œ ê³ ê°ì˜ ìš”ì²­ì´ ì™€ì•¼ ìƒì„±ê°€ëŠ¥ !

**SOLUTION**

**1) Provider**

- ObjectProvider.getObject() í˜¸ì¶œí•˜ëŠ” ì‹œì ê¹Œì§€ request scope ë¹ˆì˜
ìƒì„±ì„ ì§€ì—°
- ObjectProvider.getObject() í˜¸ì¶œí•˜ëŠ” ì‹œì ì—ëŠ” HTTP ìš”ì²­ì´ ì§„í–‰ì¤‘ â†’ request scope ë¹ˆ ìƒì„±
- ObjectProvider.getObject() LogDemoController , LogDemoService ì—ì„œ ê°ê° í•œë²ˆì”© ë”°ë¡œ í˜¸ì¶œ,
    
    ê°™ì€ HTTP ìš”ì²­ì´ë©´ â†’ ê°™ì€ ìŠ¤í”„ë§ ë¹ˆì´ ë°˜í™˜
    

```java
@Controller
@RequiredArgsConstructor
public class LogDemoController {
    private final LogDemoService logDemoService;
    private final ObjectProvider<MyLogger> myLoggerProvider;
    @RequestMapping("log-demo")
    @ResponseBody
    public String logDemo(HttpServletRequest request) {
        String requestURL = request.getRequestURL().toString();
        MyLogger myLogger = myLoggerProvider.getObject();
        myLogger.setRequestURL(requestURL);
        myLogger.log("controller test");
        logDemoService.logic("testId");
        return "OK";
    }
}
```

```java
@Service
@RequiredArgsConstructor
public class LogDemoService {
    private final ObjectProvider<MyLogger> myLoggerProvider;
    public void logic(String id) {
        MyLogger myLogger = myLoggerProvider.getObject();
        myLogger.log("service id = " + id);
    }
}
```

**2) í”„ë¡ì‹œ**

- ì ìš© ëŒ€ìƒ â†’ í´ë˜ìŠ¤ : TARGET_CLASS
- ì ìš© ëŒ€ìƒ â†’ ì¸í„°í˜ì´ìŠ¤ : INTERFACES

```java
@Component
@Scope(value = "request", proxyMode = ScopedProxyMode.TARGET_CLASS)
public class MyLogger {
}
```

CGLIBë¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ë‚´ í´ë˜ìŠ¤ë¥¼ ìƒì† ë°›ì€ ê°€ì§œ í”„ë¡ì‹œ ê°ì²´ë¥¼ ë§Œë“¤ì–´ì„œ ì£¼ì… â†’ì‹¤ì œ ìš”ì²­ì´ ì˜¤ë©´ ë‚´ë¶€ì—ì„œ ì‹¤ì œ ë¹ˆì„ ìš”ì²­í•˜ëŠ” ìœ„ì„ ë¡œì§

- ê°€ì§œ í”„ë¡ì‹œ ê°ì²´ ë‚´ë¶€ì— ë‹¨ìˆœí•œ ìœ„ì„ ë¡œì§ë§Œ ìˆê³ , ì‹±ê¸€í†¤ ì²˜ëŸ¼ ë™ì‘

![Untitled 5](https://github.com/LAB-2023/LAB_study/assets/125250173/83146855-95ee-4fe8-b460-563270b96e64)

**íŠ¹ì§•**

- í´ë¼ì´ì–¸íŠ¸ëŠ” ë§ˆì¹˜ ì‹±ê¸€í†¤ ë¹ˆì„ ì‚¬ìš©í•˜ë“¯ì´ í¸ë¦¬í•˜ê²Œ request scopeë¥¼ ì‚¬ìš©
- ì• ë…¸í…Œì´ì…˜ ì„¤ì • ë³€ê²½ë§Œìœ¼ë¡œ ì›ë³¸ ê°ì²´ë¥¼ í”„ë¡ì‹œ ê°ì²´ë¡œ ëŒ€ì²´ ê°€ëŠ¥
- ê¼­ ì›¹ ìŠ¤ì½”í”„ê°€ ì•„ë‹ˆì–´ë„ í”„ë¡ì‹œëŠ” ì‚¬ìš©ê°€ëŠ¥
